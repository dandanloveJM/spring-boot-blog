<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.ProjectMapper">
    <select id="selectProjects" resultMap="project" >
        select
        project.id,
        project.process_id,
        project.name,
        project.number,
        project.type,
        project.attachment,
        project.owner_id,
        project.product_id,
        project.created_at,
        project.updated_at,
        project.total_product,
        project.total_percentage
        FROM project
        <if test="userId != null">
            WHERE project.owner_id = #{userId}
        </if>
        order by project.updated_at desc
        limit ${offset}, #{limit}
    </select>
    <select id="countProject" resultType="int">
        select count(*) from project
        <if test="userId != null">
            WHERE owner_id = ${userId}
        </if>
    </select>
    <select id="getProjectById" resultMap="project">
        SELECT
        project.id,
        project.process_id,
        project.name,
        project.number,
        project.type,
        project.attachment,
        project.owner_id,
        project.product_id,
        project.created_at,
        project.updated_at,
        project.total_product,
        project.total_percentage
        FROM project
        where project.id = ${projectId}
    </select>

    <select id="getProjectByProcessId" parameterType="String" resultMap="project">
            SELECT
            project.id,
            project.process_id,
            project.name,
            project.number,
            project.type,
            project.attachment,
            project.owner_id,
            project.product_id,
            project.created_at,
            project.updated_at,
            project.total_product,
            project.total_percentage
            FROM project
            where project.process_id = #{processId}
        </select>

    <select id="getProjectsByProcessIds" parameterType="java.util.List" resultMap="project">
            SELECT
            project.id,
            project.process_id,
            project.name,
            project.number,
            project.type,
            project.attachment,
            project.owner_id,
            project.product_id,
            project.created_at,
            project.updated_at,
            project.total_product,
            project.total_percentage
            FROM project
            where project.process_id in
            <foreach collection="list" item="processId" index="index" open="(" separator="," close=")">
               #{processId}
            </foreach>
    </select>

    <insert id="insertProject" parameterType="hello.entity.Project" useGeneratedKeys="true"
            keyProperty="id" keyColumn="id">
        INSERT INTO project (process_id, name, number, type, attachment, owner_id, owner_name, product_id, created_at, updated_at )
        VALUES (#{processId}, #{name}, #{number}, #{type}, #{attachment}, #{ownerId}, #{owner_name},#{productId}, now(), now())
    </insert>

    <update id="updateProject" parameterType="hello.entity.Project">
        UPDATE project
        SET name=#{name}, number=#{number}, type=#{type}, attachment=#{attachment}, updated_at=now()
        where project.id = #{id}
    </update>

    <update id="updateTotalProductOfProject" parameterType="hello.entity.Project">
            UPDATE project
            SET total_product=#{totalProduct}, total_percentage=#{totalPercentage}, updated_at=now()
            where project.process_id = #{processId}
     </update>

    <delete id="deleteProject" parameterType="int">
        DELETE
        FROM project
        WHERE project.id = #{id}
    </delete>

    <delete id="deleteProjectByProcessId" parameterType="String">
        DELETE
        FROM project
        WHERE project.process_id = #{processId}
    </delete>

    <select id="getProjectsByOwnerId" resultMap="R2Projects">
        select project.id, project.process_id, project.name, project.number,
               project.type, project.owner_id, project.attachment, project.updated_at,
               project.total_product, project.total_percentage,
               p.id as product_id, p.user_id, p.display_name, p.product, p.percentage
        from project
        inner join product p on project.process_id = p.process_id
        where project.owner_id = #{ownerId}
        order by project.updated_at DESC
    </select>

    <select id="getProjectsByOwnerIds" parameterType="java.util.List" resultMap="R2Projects">
            select project.id, project.process_id, project.name, project.number,
                   project.type, project.owner_id, project.attachment, project.updated_at,
                   project.total_product, project.total_percentage,
                   p.id as product_id, p.user_id, p.display_name, p.product, p.percentage
            from project
            inner join product p on project.process_id = p.process_id
            where project.owner_id in
            <foreach collection="list" item="ownerId" index="index" open="(" separator="," close=")">
                 #{ownerId}
            </foreach>

    </select>

    <select id="getProjectsByOwnerIdsByR4" parameterType="java.util.List" resultMap="R2Projects">
                select project.id, project.process_id, project.name, project.number,
                       project.type, project.owner_id, project.attachment, project.updated_at,
                       project.total_product, project.total_percentage,
                       p.id as product_id, p.user_id, p.display_name, p.product, p.percentage
                from project
                inner join product p on project.process_id = p.process_id
                where project.owner_id in
                <foreach collection="R2Ids" item="ownerId" index="index" open="(" separator="," close=")">
                     #{ownerId}
                </foreach>
                and project.type in
                <foreach collection="typeIds" item="typeId" index="index" open="(" separator="," close=")">
                     #{typeId}
                </foreach>
        </select>

    <resultMap id="R2Projects" type="hello.entity.Project">
        <id property="id" column="id"/>
        <result property="processId" column="process_id"/>
        <result property="name" column="name"/>
        <result property="number" column="number"/>
        <result property="type" column="type"/>
        <result property="ownerId" column="owner_id"/>
        <result property="attachment" column="attachment"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="totalProduct" column="total_product"/>
        <result property="totalPercentage" column="total_percentage"/>
        <collection property="products" ofType="hello.entity.Product">
             <id property="id" column="product_id"/>
             <result property="userId" column="user_id"/>
             <result property="displayName" column="display_name"/>
             <result property="product" column="product"/>
             <result property="percentage" column="percentage"/>
        </collection>
    </resultMap>


    <resultMap id="project" type="hello.entity.Project">
        <id property="id" column="id"/>
        <result property="processId" column="process_id"/>
        <result property="name" column="name"/>
        <result property="number" column="number"/>
        <result property="type" column="type"/>
        <result property="attachment" column="attachment"/>
        <result property="ownerId" column="owner_id"/>
        <result property="productId" column="product_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="totalProduct" column="total_product"/>
        <result property="totalPercentage" column="total_percentage"/>
    </resultMap>
</mapper>